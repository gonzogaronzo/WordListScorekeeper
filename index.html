<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Student Word List and Scorecard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

        /* --- Main Window Styling --- */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            padding: 30px;
            background-color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border-radius: 20px;
            max-width: 1200px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 20px;
            }
        }

        h2 {
            color: #2c3e50;
            text-align: center;
            font-weight: 600;
            margin-top: 0;
        }

        p {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .student-setup-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .student-card {
            padding: 25px;
            border: 1px solid #dfe6e9;
            border-radius: 12px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        textarea, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            border-radius: 8px;
            border: 1px solid #bdc3c7;
            resize: none;
            font-size: 16px;
            font-family: inherit;
        }

        textarea {
            height: 150px;
        }

        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:active {
            transform: translateY(2px);
        }
        
        #generate-button {
            background-color: #3498db;
        }
        #generate-button:hover {
            background-color: #2980b9;
        }
        #load-button {
            background-color: #2ecc71;
        }
        #load-button:hover {
            background-color: #27ae60;
        }
        #export-button {
            background-color: #f39c12;
        }
        #export-button:hover {
            background-color: #e67e22;
        }

        .scorecard-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 25px;
            border: 1px solid #dfe6e9;
            border-radius: 12px;
            background-color: #ffffff;
        }

        .scorecard-grid {
            display: grid;
            width: 100%;
            gap: 5px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .grid-header {
            font-weight: 600;
            color: #34495e;
            padding: 10px;
            text-align: center;
            background-color: #ecf0f1;
            border-radius: 8px;
        }
        
        .grid-header.word-col {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: #ecf0f1;
        }

        .grid-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 10px;
            background-color: #f8fafc;
            border-radius: 8px;
        }

        .grid-cell.word-label {
            justify-content: flex-start;
            font-weight: 600;
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: #f8fafc;
        }
        
        .score-buttons {
            display: flex;
            gap: 5px;
        }

        .score-button {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        .score-button.yes { background-color: #2ecc71; }
        .score-button.yes:hover { background-color: #27ae60; }
        .score-button.no { background-color: #e74c3c; }
        .score-button.no:hover { background-color: #c0392b; }

        .score-button.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .score-button.selected {
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.7);
        }
        .score-button.selected-no {
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.7);
        }

        .score-button.grayed-out {
            background-color: #bdc3c7 !important;
            opacity: 0.4;
            box-shadow: none;
            cursor: not-allowed;
        }

        .miscue-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 5px;
        }


        .score-summary {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .score-count {
            font-size: 1.2em;
            font-weight: 600;
            color: #34495e;
        }
        .score-count span {
            color: #2ecc71;
        }
        .score-count.no span {
            color: #e74c3c;
        }
        
        #history-list {
            list-style-type: none;
            padding: 0;
        }

        #history-list li {
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #history-list li strong {
            color: #34495e;
        }

        .miscue-item {
            font-style: italic;
            color: #555;
            margin-top: 5px;
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #34495e;
            color: white;
            padding: 25px;
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            font-family: 'Inter', sans-serif;
            text-align: center;
            white-space: pre-wrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .message-box.show {
            opacity: 1;
            visibility: visible;
        }
        
        /* New button colors for reset and save */
        #reset-button {
            background-color: #bdc3c7;
        }
        #reset-button:hover {
            background-color: #95a5a6;
        }
        #save-score-button {
            background-color: #2ecc71;
        }
        #save-score-button:hover {
            background-color: #27ae60;
        }

        /* --- Second Window Styling --- */
        .word-display-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-color: #3a332d;
            color: #f4f0e9;
        }
        .word-display-container h2 {
            font-size: 1.8em;
            color: #f4f0e9;
            margin-bottom: 20px;
        }
        .word-scroll-popup {
            width: 90%;
            max-width: 500px;
            min-height: 300px;
            max-height: 70vh;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            overflow: hidden;
            border: 5px solid #bdc3c7;
            padding: 30px;
            box-sizing: border-box;
            background-color: #34495e;
            border-radius: 12px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
        }
        .word-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16pt;
            font-weight: 600;
            color: #f4f0e9;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>Multi-Student Word List and Scorecard Tool</h2>

        <div class="scorecard-section">
            <h2>Step 1: Setup</h2>
            <div class="controls-grid">
                <div class="input-group">
                    <label for="student-count-input">Number of Students:</label>
                    <input type="number" id="student-count-input" value="1" min="1" max="10">
                </div>
                <button id="generate-button">Create Student Inputs</button>
            </div>
            
            <div id="student-setup-container" class="student-setup-container"></div>
            
            <button id="load-button" style="display:none;">Load Words & Open Word Displays</button>
        </div>

        <div id="scorecard-section" class="scorecard-section" style="display:none;">
            <h2>Step 2: Scorecard</h2>
            <div id="scorecard-grid" class="scorecard-grid"></div>
            <div class="controls-grid">
                <button id="reset-button">Reset Scorecard</button>
                <button id="save-score-button">Save Score</button>
            </div>
            <div class="score-summary" id="score-summary"></div>
        </div>

        <div class="scorecard-section">
            <h2>Score History</h2>
            <ul id="history-list">
                <!-- Saved scores will be displayed here -->
            </ul>
            <button id="export-button">Export Score History</button>
        </div>
    </div>

    <div id="message-box" class="message-box"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const studentCountInput = document.getElementById('student-count-input');
            const generateButton = document.getElementById('generate-button');
            const loadButton = document.getElementById('load-button');
            const studentSetupContainer = document.getElementById('student-setup-container');
            const scorecardSection = document.getElementById('scorecard-section');
            const scorecardGrid = document.getElementById('scorecard-grid');
            const resetButton = document.getElementById('reset-button');
            const saveScoreButton = document.getElementById('save-score-button');
            const exportButton = document.getElementById('export-button');
            const scoreSummary = document.getElementById('score-summary');
            const messageBox = document.getElementById('message-box');
            const historyList = document.getElementById('history-list');

            const maxWords = 15;
            const localStorageKey = 'multi_student_scores';
            let studentData = [];

            // Function to generate the student name and word list inputs
            const generateStudentInputs = () => {
                const studentCount = parseInt(studentCountInput.value, 10);
                studentSetupContainer.innerHTML = '';
                studentData = [];
                scorecardSection.style.display = 'none';
                loadButton.style.display = 'none';

                for (let i = 0; i < studentCount; i++) {
                    const studentCard = document.createElement('div');
                    studentCard.classList.add('student-card');
                    studentCard.innerHTML = `
                        <h3>Student ${i + 1}</h3>
                        <div class="input-group">
                            <label for="student-name-${i}">Name:</label>
                            <input type="text" id="student-name-${i}" placeholder="Enter name...">
                        </div>
                        <div class="input-group">
                            <label for="word-list-${i}">Word List (up to 15 words):</label>
                            <textarea id="word-list-${i}" placeholder="One word per line..."></textarea>
                        </div>
                    `;
                    studentSetupContainer.appendChild(studentCard);
                    studentData.push({
                        name: '',
                        words: [],
                        yesCount: 0,
                        noCount: 0,
                        miscues: Array(maxWords).fill('')
                    });
                }
                
                // Show the load button after inputs are generated
                if (studentCount >= 1) {
                    loadButton.style.display = 'block';
                }
            };
            
            // Function to load and render saved scores from local storage
            const loadAndRenderHistory = () => {
                try {
                    const savedSessions = JSON.parse(localStorage.getItem(localStorageKey)) || [];
                    historyList.innerHTML = '';
                    if (savedSessions.length === 0) {
                        historyList.innerHTML = '<li>No scores saved yet.</li>';
                    } else {
                        savedSessions.forEach((session) => {
                            const listItem = document.createElement('li');
                            const date = new Date(session.timestamp).toLocaleString();
                            const studentScores = session.students.map(s => {
                                const miscueText = s.miscues.filter(m => m !== '').join(', ');
                                return `<strong>${s.name || 'No Name'}:</strong> Yes: ${s.yes}, No: ${s.no}${miscueText ? `<br><em>Miscues: ${miscueText}</em>` : ''}`;
                            }).join('<br>');
                            listItem.innerHTML = `
                                <strong>Date:</strong> ${date}<br>
                                ${studentScores}
                            `;
                            historyList.appendChild(listItem);
                        });
                    }
                } catch (e) {
                    console.error("Failed to load history from local storage:", e);
                    historyList.innerHTML = '<li>Error loading history.</li>';
                }
            };

            // Initial setup
            generateStudentInputs();
            loadAndRenderHistory();

            generateButton.addEventListener('click', generateStudentInputs);

            loadButton.addEventListener('click', () => {
                const studentCount = parseInt(studentCountInput.value, 10);
                if (studentCount <= 0) {
                    showMessage("Please enter a valid number of students (1 or more).");
                    return;
                }

                studentData = [];
                let hasWords = false;

                for (let i = 0; i < studentCount; i++) {
                    const name = document.getElementById(`student-name-${i}`).value.trim() || `Student ${i + 1}`;
                    const words = document.getElementById(`word-list-${i}`).value.split('\\n').filter(word => word.trim() !== '').slice(0, maxWords);
                    
                    studentData.push({
                        name,
                        words,
                        yesCount: 0,
                        noCount: 0,
                        miscues: Array(maxWords).fill('')
                    });

                    if (words.length > 0) {
                        hasWords = true;
                    }
                    
                    // Open a new window for each student's word list
                    const popupHTML = generatePopupContent(name, words);
                    const newWindow = window.open('', `student-${i}`, 'width=400,height=600,resizable=yes');
                    if (newWindow) {
                        newWindow.document.write(popupHTML);
                        newWindow.document.close();
                    } else {
                        showMessage("Pop-up blocked! Please allow pop-ups for this site to open the word list windows.");
                    }
                }
                
                if (!hasWords) {
                    showMessage("Please enter at least one word for a student.");
                    return;
                }

                // Generate and display the scorecard
                generateScorecard();
            });

            const generateScorecard = () => {
                scorecardSection.style.display = 'flex';
                scorecardGrid.innerHTML = '';
                scoreSummary.innerHTML = '';

                // Get the maximum word count from the student lists
                const maxWordCount = studentData.reduce((max, student) => Math.max(max, student.words.length), 0);
                if (maxWordCount === 0) return;

                // Set up the CSS grid columns dynamically
                scorecardGrid.style.gridTemplateColumns = `minmax(100px, 1fr) repeat(${studentData.length}, 1fr)`;

                // Add header row
                const wordHeader = document.createElement('div');
                wordHeader.classList.add('grid-header', 'word-col');
                wordHeader.textContent = 'Word';
                scorecardGrid.appendChild(wordHeader);

                studentData.forEach(student => {
                    const nameHeader = document.createElement('div');
                    nameHeader.classList.add('grid-header');
                    nameHeader.textContent = student.name;
                    scorecardGrid.appendChild(nameHeader);
                });

                // Add rows for each word
                for (let i = 0; i < maxWords; i++) {
                    const wordLabel = document.createElement('div');
                    wordLabel.classList.add('grid-cell', 'word-label');
                    // Use the first student's word list to populate the word labels
                    wordLabel.textContent = `${i + 1}. ${studentData[0].words[i] || ''}`;
                    scorecardGrid.appendChild(wordLabel);

                    studentData.forEach((student, studentIndex) => {
                        const scoreCell = document.createElement('div');
                        scoreCell.classList.add('grid-cell');
                        if (i < student.words.length) {
                             scoreCell.innerHTML = `
                                <div class="score-buttons">
                                    <button class="score-button yes" data-student-index="${studentIndex}" data-word-index="${i}">Y</button>
                                    <button class="score-button no" data-student-index="${studentIndex}" data-word-index="${i}">N</button>
                                </div>
                                <input type="text" class="miscue-input" placeholder="Enter miscue..." style="display:none;">
                            `;
                        }
                       
                        scorecardGrid.appendChild(scoreCell);
                    });
                }

                updateScoreSummary();
            };

            const updateScoreSummary = () => {
                scoreSummary.innerHTML = '';
                studentData.forEach(student => {
                    const summaryItem = document.createElement('div');
                    summaryItem.innerHTML = `
                        <strong>${student.name}</strong><br>
                        <span class="score-count">Yes: <span class="yes">${student.yesCount}</span></span> |
                        <span class="score-count no">No: <span class="no">${student.noCount}</span></span>
                    `;
                    scoreSummary.appendChild(summaryItem);
                });
            };

            scorecardGrid.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('score-button')) {
                    const studentIndex = parseInt(target.dataset.studentIndex, 10);
                    const wordIndex = parseInt(target.dataset.wordIndex, 10);
                    const buttonType = target.classList.contains('yes') ? 'yes' : 'no';
                    
                    const parent = target.closest('.grid-cell');
                    const allButtons = parent.querySelectorAll('.score-button');
                    const miscueInput = parent.querySelector('.miscue-input');

                    // Disable all buttons in the cell
                    allButtons.forEach(btn => {
                        btn.disabled = true;
                        if (btn !== target) {
                            btn.classList.add('grayed-out');
                        }
                    });
                    
                    // Highlight the selected button and handle miscue input
                    if (buttonType === 'yes') {
                        target.classList.add('selected');
                        if (miscueInput) {
                            miscueInput.style.display = 'none';
                        }
                    } else {
                        target.classList.add('selected-no');
                        if (miscueInput) {
                            miscueInput.style.display = 'block';
                            miscueInput.focus();
                        }
                    }
                    
                    if (buttonType === 'yes') {
                        studentData[studentIndex].yesCount++;
                    } else {
                        studentData[studentIndex].noCount++;
                    }
                    updateScoreSummary();
                }
            });

            resetButton.addEventListener('click', () => {
                studentData.forEach(student => {
                    student.yesCount = 0;
                    student.noCount = 0;
                });
                
                scorecardGrid.querySelectorAll('.score-button').forEach(button => {
                    button.disabled = false;
                    button.classList.remove('disabled', 'grayed-out', 'selected', 'selected-no');
                });

                scorecardGrid.querySelectorAll('.miscue-input').forEach(input => {
                    input.value = '';
                    input.style.display = 'none';
                });
                
                studentData.forEach(student => student.miscues = Array(maxWords).fill(''));
                updateScoreSummary();
            });

            saveScoreButton.addEventListener('click', () => {
                // First, capture all miscue data from the visible inputs
                const miscueInputs = scorecardGrid.querySelectorAll('.miscue-input');
                miscueInputs.forEach(input => {
                    const studentIndex = parseInt(input.closest('.grid-cell').querySelector('.score-button').dataset.studentIndex, 10);
                    const wordIndex = parseInt(input.closest('.grid-cell').querySelector('.score-button').dataset.wordIndex, 10);
                    studentData[studentIndex].miscues[wordIndex] = input.value.trim();
                });

                try {
                    const savedSessions = JSON.parse(localStorage.getItem(localStorageKey)) || [];
                    const sessionData = {
                        timestamp: new Date().toISOString(),
                        students: studentData.map(s => ({
                            name: s.name,
                            yes: s.yesCount,
                            no: s.noCount,
                            words: s.words,
                            miscues: s.miscues
                        }))
                    };
                    savedSessions.unshift(sessionData);
                    localStorage.setItem(localStorageKey, JSON.stringify(savedSessions));
                    showMessage("Scores saved successfully!");
                    loadAndRenderHistory();
                } catch (e) {
                    console.error("Error saving to local storage:", e);
                    showMessage("Error saving score.");
                }
            });

            exportButton.addEventListener('click', () => {
                try {
                    const savedSessions = JSON.parse(localStorage.getItem(localStorageKey)) || [];
                    if (savedSessions.length === 0) {
                        showMessage("No data to export.");
                        return;
                    }
                    
                    let csvContent = "Date,Student,Correct,Incorrect,Miscue,Word List\\n";

                    savedSessions.forEach(session => {
                        const date = new Date(session.timestamp).toLocaleString();
                        session.students.forEach(student => {
                            const miscueText = student.miscues.filter(m => m !== '').join('; ');
                            const wordListText = student.words.join('; ');
                            const row = f'"{date}","{student.name}","{student.yes}","{student.no}","{miscueText}","{wordListText}"\\n';
                            csvContent += row;
                        });
                    });

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', 'score_history.csv');
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showMessage("Export successful! Check your downloads folder.");
                    }
                } catch (e) {
                    console.error("Error exporting data:", e);
                    showMessage("Error exporting data.");
                }
            });

            studentCountInput.addEventListener('change', () => {
                generateStudentInputs();
            });

            function showMessage(text) {
                messageBox.textContent = text;
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 3000);
            }

            function generatePopupContent(studentName, words) {
                const wordItems = words.map((word, index) => `
                    <div class="word-item">${index + 1}. ${word.trim()}</div>
                `).join('');

                return `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>${studentName}'s Word List</title>
                        <style>
                            body { margin: 0; font-family: 'Inter', sans-serif; }
                            .word-display-container {
                                width: 100%; height: 100vh; display: flex; flex-direction: column;
                                align-items: center; justify-content: center; padding: 20px;
                                background-color: #3a332d;
                                color: #f4f0e9;
                            }
                            .word-display-container h2 {
                                font-size: 1.8em;
                                color: #f4f0e9;
                                margin-bottom: 20px;
                            }
                            .word-scroll-popup {
                                width: 90%;
                                max-width: 500px;
                                min-height: 300px;
                                max-height: 70vh;
                                display: grid;
                                grid-template-columns: repeat(3, 1fr);
                                gap: 15px;
                                overflow: hidden;
                                border: 5px solid #bdc3c7;
                                padding: 30px;
                                box-sizing: border-box;
                                background-color: #34495e;
                                border-radius: 12px;
                                box-shadow: 0 8px 15px rgba(0,0,0,0.3);
                            }
                            .word-item {
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 16pt;
                                font-weight: 600;
                                color: #f4f0e9;
                                text-align: center;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="word-display-container">
                            <h2>${studentName}'s Words</h2>
                            <div class="word-scroll-popup">
                                ${wordItems}
                            </div>
                        </div>
                    </body>
                    </html>
                `;
            }

            document.getElementById('student-count-input').dispatchEvent(new Event('change'));
        });
    </script>
</body>
</html>
